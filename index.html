<!doctype html>
document.getElementById('auth-card').classList.add('hidden');
document.getElementById('main-ui').classList.remove('hidden');
document.getElementById('me-photo').src = user.photo||('https://picsum.photos/seed/'+user.username+'/96');
document.getElementById('me-name').textContent = user.display||user.username;
document.getElementById('me-username').textContent = '@'+user.username;
document.getElementById('my-obs-token').value = user.obsToken||'';
loadUsersList();
// watch own sent messages
db.collection('messages').where('from','==',user.id).orderBy('createdAt','desc').limit(20).onSnapshot(s=>{
const el = document.getElementById('sent-list'); el.innerHTML='';
s.forEach(doc=>{const m=doc.data(); el.innerHTML += `<div>${new Date(m.createdAt).toLocaleString()} → ${m.to}</div>`})
})
}


document.getElementById('regen-token').onclick = async ()=>{
if(!currentUser) return; const tok = makeToken(); await db.collection('users').doc(currentUser.id).update({obsToken:tok}); currentUser.obsToken=tok; localStorage.setItem('scotchy_user',JSON.stringify(currentUser)); document.getElementById('my-obs-token').value=tok; alert('Token régénéré'); loadUsersList();
}


// ---------------------- SEND MESSAGE (upload or link) ----------------------
// Drag & drop
const fileInput = document.getElementById('file-input');
fileInput.addEventListener('change', ()=>{});


document.getElementById('btn-send').onclick = async ()=>{
if(!currentUser){alert('Connecte-toi');return}
const text = document.getElementById('text-input').value.trim();
const toId = document.getElementById('recipient-select').value;
const url = document.getElementById('url-input').value.trim();
const f = fileInput.files[0];
if(!text||!toId){alert('Texte et destinataire obligatoires');return}
let mediaUrl = '';
let mime = '';
if(f){
const ref = storage.ref().child('uploads/'+Date.now()+'_'+f.name);
const task = await ref.put(f);
mediaUrl = await ref.getDownloadURL();
mime = f.type;
} else if(url){
mediaUrl = url; // remote link
mime = url.split('.').pop().includes('mp3')? 'audio/mpeg' : 'video/mp4';
} else {alert('Fichier ou lien requis');return}
const message = {from:currentUser.id,to:toId,mediaUrl,text, mime, createdAt:Date.now(), played:false, senderPhoto:currentUser.photo||'', senderName:currentUser.display||currentUser.username}
await db.collection('messages').add(message);
alert('Envoyé ✅');
document.getElementById('text-input').value=''; document.getElementById('url-input').value=''; fileInput.value='';
}


// periodically refresh recipients (for new accounts)
setInterval(()=>{ if(db) loadUsersList() },5000);
</script>
</body>
</html>
